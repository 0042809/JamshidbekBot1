from telegram import Update, ReplyKeyboardMarkup, KeyboardButton
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, filters, CallbackContext

ADMIN_CHAT_ID = 948716961  # Admin ID ni bu yerga kiriting
ADMIN_CHAT_ID1 = 7255953399

async def start(update: Update, context: CallbackContext):
    # Foydalanuvchidan til tanlashni kutayotganini belgilaymiz
    context.user_data['awaiting_language'] = True

    keyboard = [['Oâ€˜zbekcha ğŸ‡ºğŸ‡¿', 'Ğ ÑƒÑÑĞºĞ¸Ğ¹ ğŸ‡·ğŸ‡º', 'English ğŸ‡¬ğŸ‡§']]
    reply_markup = ReplyKeyboardMarkup(keyboard, one_time_keyboard=True)
    await update.message.reply_text(
        ":Tilni tanlang / Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑĞ·Ñ‹Ğº / Choose your language",
        reply_markup=reply_markup
    )

async def language_selection(update: Update, context: CallbackContext):
    # Agar til tanlash bosqichi bo'lmasa, hech narsa qilmaslik
    if not context.user_data.get('awaiting_language', False):
        return

    selected_language = update.message.text
    if selected_language == 'Oâ€˜zbekcha ğŸ‡ºğŸ‡¿':
        context.user_data['language'] = 'uz'
    elif selected_language == 'Ğ ÑƒÑÑĞºĞ¸Ğ¹ ğŸ‡·ğŸ‡º':
        context.user_data['language'] = 'ru'
    elif selected_language == 'English ğŸ‡¬ğŸ‡§':
        context.user_data['language'] = 'en'
    else:
        await update.message.reply_text("Iltimos, toâ€˜gâ€˜ri tanlov qiling va menyudagi tugmalarni ishlating.")
        return

    # Til tanlash yakunlandi
    context.user_data['awaiting_language'] = False
    await main_menu(update, context)

async def main_menu(update: Update, context: CallbackContext):
    language = context.user_data.get('language', 'uz')
    if language == 'uz':
        button_text = "Jamshidbekka yozish"
        greeting = "Sizning tanlovingiz: Oâ€˜zbek tili."
    elif language == 'ru':
        button_text = "ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ–Ğ°Ğ¼ÑˆĞ¸Ğ´Ğ±ĞµĞºÑƒ"
        greeting = "Ğ’Ğ°Ñˆ Ğ²Ñ‹Ğ±Ğ¾Ñ€: Ğ ÑƒÑÑĞºĞ¸Ğ¹ ÑĞ·Ñ‹Ğº."
    else:
        button_text = "Write to Jamshidbek"
        greeting = "Your choice: English."

    keyboard = [[KeyboardButton(button_text)]]
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    await update.message.reply_text(
        greeting,
        reply_markup=reply_markup
    )

async def handle_write_request(update: Update, context: CallbackContext):
    language = context.user_data.get('language', 'uz')
    if language == 'uz':
        prompt = ("Jamshidbekka yozish uchun quyidagilarni toâ€˜ldiring:\n"
                  "1. Kim ekanligingizni yozing.\n"
                  "2. Murojaatingizning maqsadi.\n"
                  "3. Bogâ€˜lanish maâ€™lumotlaringiz (telefon, email, Telegram va hokazo).")
    elif language == 'ru':
        prompt = ("Ğ§Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ–Ğ°Ğ¼ÑˆĞ¸Ğ´Ğ±ĞµĞºÑƒ, Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ ÑĞ»ĞµĞ´ÑƒÑÑ‰ĞµĞµ:\n"
                  "1. ĞšÑ‚Ğ¾ Ğ²Ñ‹.\n"
                  "2. Ğ¦ĞµĞ»ÑŒ Ğ²Ğ°ÑˆĞµĞ³Ğ¾ Ğ¾Ğ±Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ñ.\n"
                  "3. Ğ’Ğ°ÑˆĞ¸ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ (Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½, email, Telegram Ğ¸ Ñ‚.Ğ´.).")
    else:
        prompt = ("To write to Jamshidbek, please fill out the following:\n"
                  "1. Who you are.\n"
                  "2. Purpose of your message.\n"
                  "3. Your contact details (phone, email, Telegram, etc.).")

    # Belgilaymizki, foydalanuvchi xabar yozmoqda
    context.user_data['writing_message'] = True
    await update.message.reply_text(prompt)

async def forward_to_admin(update: Update, context: CallbackContext):
    # Faqat "writing_message" holatida xabarni qabul qilish
    if context.user_data.get('writing_message', False):
        user_message = update.message.text
        user_info = f"Foydalanuvchi: {update.effective_user.full_name}\nXabar:\n{user_message}"
        await context.bot.send_message(chat_id=ADMIN_CHAT_ID, text=user_info)
        await context.bot.send_message(chat_id=ADMIN_CHAT_ID1, text=user_info)

        # Holatni qayta oâ€˜chirib qoâ€˜yamiz
        context.user_data['writing_message'] = False

        # Tasdiq xabarini yuboramiz
        await update.message.reply_text("Xabaringiz Jamshidbekka yuborildi!\n"
                                        "Ğ’Ğ°ÑˆĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ Ğ–Ğ°Ğ¼ÑˆĞ¸Ğ´Ğ±ĞµĞºÑƒ!\n"
                                        "Your message has been sent to Jamshidbek!")

if __name__ == "__main__":
    app = ApplicationBuilder().token("7256972823:AAEs_zx_OdCukZurrDeBebAr6tCOnodfeZQ").build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(
        MessageHandler(filters.Regex("^(Oâ€˜zbekcha ğŸ‡ºğŸ‡¿|Ğ ÑƒÑÑĞºĞ¸Ğ¹ ğŸ‡·ğŸ‡º|English ğŸ‡¬ğŸ‡§)$"),
                       language_selection)
    )
    app.add_handler(
        MessageHandler(filters.Regex("^(Jamshidbekka yozish|ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ–Ğ°Ğ¼ÑˆĞ¸Ğ´Ğ±ĞµĞºÑƒ|Write to Jamshidbek)$"),
                       handle_write_request)
    )
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, forward_to_admin))

    print("Bot ishlayapti...")
    app.run_polling()

